name: Apple Trailer Download with Manzana (Fixed)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: '粘贴 Apple TV+ 网页 URL'
        required: true
      quality:
        type: choice
        description: '选择画质类型'
        options:
          - '4K (DoVi/HDR)'
          - '1080p (SDR)'
        default: '4K (DoVi/HDR)'

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Clone and Install
        run: |
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers
          pip install -r requirements.txt

      - name: Execute Manzana (Automated Input)
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          
          # 模拟交互输入逻辑：
          # 第一次输入：选择 Codec ID (0为DoVi, 1为SDR)
          # 第二次输入：选择 分辨率 ID (通常0为最高)
          # 第三次输入：选择 音频 (all 代表全部下载)
          # 第四次输入：选择 字幕 (all 代表全部下载)
          
          if [ "${{ github.event.inputs.quality }}" == "4K (DoVi/HDR)" ]; then
            # 顺序：Codec(0) -> Resolution(0) -> Audio(all) -> Subs(all)
            printf "0\n0\nall\nall\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d
          else
            # 顺序：Codec(1:SDR) -> Resolution(0) -> Audio(all) -> Subs(all)
            printf "1\n0\nall\nall\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d
          fi

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Trailers_Manzana
          path: |
             Manzana-Apple-TV-Plus-Trailers/*.mp4
             Manzana-Apple-TV-Plus-Trailers/*.mkv
          retention-days: 1
