name: Apple Trailer Manzana (v2.2-Scope)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: '粘贴 Apple TV+ 网页 URL'
        required: true
      mode:
        type: choice
        description: '选择下载预设'
        options:
          - '4K_HDR_Best'
          - '1080p_SDR_Best'
          - 'Custom_IDs'
        default: '4K_HDR_Best'
      custom_sequence:
        description: '若选 Custom_IDs，请填入序列'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v2.2-Checkout
        uses: actions/checkout@v4

      - name: v2.2-Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac

      - name: v2.2-Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: v2.2-Clone and Install
        run: |
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers
          pip install -r requirements.txt

      - name: v2.2-Execute Manzana
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          if [ "${{ github.event.inputs.mode }}" == "4K_HDR_Best" ]; then
            INPUT_SEQ="0\n13\nall\nall\nall\nall\n"
          elif [ "${{ github.event.inputs.mode }}" == "1080p_SDR_Best" ]; then
            INPUT_SEQ="1\n11\nall\nall\nall\nall\n"
          else
            INPUT_SEQ="${{ github.event.inputs.custom_sequence }}"
          fi
          printf "$INPUT_SEQ" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v2.2-Locate and Move
        if: always()
        run: |
          mkdir -p final_output
          echo "=== 路径审计：正在定位生成的视频文件 ==="
          # 在整个工作区搜索 mp4，排除掉 final_output 目录本身
          # 这将显示文件的真实路径，解决我们的困惑
          find . -type f \( -name "*.mp4" -o -name "*.mkv" \) -not -path "./final_output/*" > file_list.txt
          
          echo "查找到的文件位置："
          cat file_list.txt
          
          echo "=== 开始移动文件 ==="
          while read line; do
            echo "正在移动: $line"
            mv "$line" ./final_output/
          done < file_list.txt

          echo "=== 检查提取结果 ==="
          ls -lh ./final_output

      - name: v2.2-Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_v2.2
          path: final_output/*
          retention-days: 1
