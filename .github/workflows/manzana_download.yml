name: Apple Trailer Manzana (v5.0-Universal)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Á≤òË¥¥ Apple TV+ ÁΩëÈ°µ URL'
        required: true
      action_type:
        type: choice
        description: 'Ê®°ÂºèÈÄâÊã©'
        options:
          - 'Probe_All_Details'
          - 'Formal_Download'
        default: 'Probe_All_Details'
      custom_sequence:
        description: '„ÄêÊ≠£Âºè‰∏ãËΩΩÂ°´ÂÖ•„Äë‰æãÂ¶Ç: 2\n25\nall\nall\nall\nall\n'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v5.0-Checkout
        uses: actions/checkout@v4

      - name: v5.0-Setup Env
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      # ---------------- Êé¢ÊµãÊ®°ÂºèÔºöËé∑ÂèñÂÖ®ÈáèËèúÂçï ----------------
      - name: v5.0-Universal Probe
        if: github.event.inputs.action_type == 'Probe_All_Details'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "üîç Ê≠£Âú®ËøõË°åÂÖ®ÈáèÊâ´Êèè (inducing all tables)..."
          
          # 1. ËøêË°åÂπ∂ÂÆûÊó∂‰øùÂ≠òÂéüÂßãÊó•ÂøóÔºåÂêåÊó∂Âú®Ê£ÄÊµãÂà∞ÂºÄÂßã‰∏ãËΩΩÊó∂ÊùÄÊéâËøõÁ®ã
          # ‰ΩøÁî® all Â∫èÂàóËØ±ÂØºÊúÄÂÖ®Ë°®Ê†º
          (printf "all\nall\nall\nall\nall\nall\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d 2>&1 | tee ../raw_full.log) & 
          
          # Á≠âÂæÖÊé¢ÊµãÔºåÁõ¥Âà∞Êó•ÂøóÂá∫Áé∞‰∏ãËΩΩ‰ø°Âè∑ÊàñË∂ÖÊó∂ 60s
          for i in {1..60}; do
            if grep -q "Downloading segments" ../raw_full.log; then
              echo "‚úÖ Â∑≤ÊçïËé∑ÊâÄÊúâË°®Ê†ºÔºåÊ≠£Âú®Êã¶Êà™‰∏ãËΩΩ‰ª•ËäÇÁúÅÊµÅÈáè..."
              pkill -f python
              break
            fi
            sleep 1
          done
          
          # 2. Ê∏ÖÊ¥óÊó•ÂøóÔºöÁßªÈô§È¢úËâ≤‰ª£Á†ÅÔºåÊèêÂèñË°®Ê†º
          cd ..
          sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g" raw_full.log > Full_Report.txt
          
          echo "--- Êä•ÂëäÈ¢ÑËßà (ID ËèúÂçï) ---"
          grep -E "‚îÇ|‚ï≠|‚ï∞|ID|Codec|Bitrate|Language|Content|Range" Full_Report.txt | head -n 50

      - name: v5.0-Upload Report
        if: github.event.inputs.action_type == 'Probe_All_Details'
        uses: actions/upload-artifact@v4
        with:
          name: Full_ID_Menu
          path: Full_Report.txt

      # ---------------- Ê≠£Âºè‰∏ãËΩΩÔºöÁ≤æÂáÜ‰∫§‰ªò ----------------
      - name: v5.0-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v5.0-Extraction
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          [ -d "./Manzana-Apple-TV-Plus-Trailers/output" ] && mv ./Manzana-Apple-TV-Plus-Trailers/output/* ./final_delivery/ || true
          find ./Manzana-Apple-TV-Plus-Trailers -maxdepth 1 -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./final_delivery/ \;

      - name: v5.0-Upload Result
        if: github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_v5.0
          path: final_delivery/*
