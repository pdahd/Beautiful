name: Apple Trailer Manzana (v4.0-Strategist)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true
      action_type:
        type: choice
        description: 'ç¬¬ä¸€æ­¥ï¼šæ¢æµ‹ ID åˆ—è¡¨ï¼›ç¬¬äºŒæ­¥ï¼šæ­£å¼ä¸‹è½½'
        options:
          - 'Probe_IDs_Only'
          - 'Formal_Download'
        default: 'Probe_IDs_Only'
      custom_sequence:
        description: 'ã€ä»…æ­£å¼ä¸‹è½½ä½¿ç”¨ã€‘å¡«å…¥ ID åºåˆ— (ä¾‹å¦‚ 0\n13\nall\n4,40\nall\n2,50\n)'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v4.0-Checkout
        uses: actions/checkout@v4

      - name: v4.0-Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          pip install -r Manzana-Apple-TV-Plus-Trailers/requirements.txt || true
          # æ³¨æ„ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œéœ€è¦å…‹éš†
          if [ ! -d "Manzana-Apple-TV-Plus-Trailers" ]; then
            git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
            cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt
          fi

      # ---------------- æ¨¡å¼ 1ï¼šæ¢æµ‹ ID ----------------
      - name: v4.0-Probe Mode
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ğŸ” æ­£åœ¨æŠ“å–è¯¥ URL çš„æ‰€æœ‰å¯ç”¨æµ ID..."
          # é€šè¿‡å‘é€ä¸€ä¸ªé”™è¯¯çš„è¾“å…¥åºåˆ—ï¼Œå¼ºåˆ¶è„šæœ¬åœ¨æ‰“å°å®Œè¡¨æ ¼åå› è¾“å…¥é”™è¯¯æˆ– EOF é€€å‡º
          # è¿™æ ·æˆ‘ä»¬å°±èƒ½æ‹¿åˆ°è¡¨æ ¼ï¼Œä½†ä¸ä¼šè§¦å‘å®é™…ä¸‹è½½
          printf "invalid\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d > ../stream_info.txt 2>&1 || true
          
          echo "=== æ¢æµ‹æŠ¥å‘Šæ‘˜è¦ ==="
          cat ../stream_info.txt | grep -A 100 "Fetching video ranges" > ../Stream_Report.txt
          cat ../Stream_Report.txt

      - name: v4.0-Upload Report
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        uses: actions/upload-artifact@v4
        with:
          name: Stream_Analysis_Report
          path: Stream_Report.txt

      # ---------------- æ¨¡å¼ 2ï¼šæ­£å¼ä¸‹è½½ ----------------
      - name: v4.0-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ğŸš€ ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—å¯åŠ¨ç²¾å‡†ä¸‹è½½: ${{ github.event.inputs.custom_sequence }}"
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v4.0-Precision Extraction
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          SRC_DIR="./Manzana-Apple-TV-Plus-Trailers/output"
          if [ -d "$SRC_DIR" ]; then
            mv "$SRC_DIR"/* ./final_delivery/
          else
            find ./Manzana-Apple-TV-Plus-Trailers -name "*.mp4" -exec mv {} ./final_delivery/ \;
          fi

      - name: v4.0-Upload Result
        if: github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Trailer_v4.0_Final
          path: final_delivery/*
