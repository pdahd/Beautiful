name: Apple Trailer Manzana (v5.6-Final)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true
      action_type:
        type: choice
        description: 'æ¨¡å¼é€‰æ‹© (ç¬¬ä¸€æ­¥æŽ¢æµ‹èœå•ï¼Œç¬¬äºŒæ­¥æ­£å¼ä¸‹è½½)'
        options:
          - 'Probe_All_Details'
          - 'Formal_Download'
        default: 'Probe_All_Details'
      custom_sequence:
        description: 'ã€æ­£å¼ä¸‹è½½å¡«å…¥ã€‘æ ¹æ®æŽ¢æµ‹æŠ¥å‘Šç»„åˆ IDï¼Œä¾‹å¦‚: 0\n13\nall\n4\nall\n2\n'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v5.6-Checkout
        uses: actions/checkout@v4

      - name: v5.6-Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          if [ ! -d "Manzana-Apple-TV-Plus-Trailers" ]; then
            git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          fi
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      # ---------------- æ¨¡å¼ 1ï¼šæžè‡´æŽ¢æµ‹æ¨¡å¼ (å…¨é‡ ID èœå•) ----------------
      - name: v5.6-Precision Probe
        if: github.event.inputs.action_type == 'Probe_All_Details'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ðŸ” æ­£åœ¨è¿›è¡Œæ··åˆè¯±å¯¼æŽ¢æµ‹ (Range=0, Stream=13, Others=all)..."
          
          # å¯åŠ¨åŽå°è¿›ç¨‹ï¼šè¾“å…¥ 0 -> 13 -> all -> all -> all -> all
          (printf "0\n13\nall\nall\nall\nall\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d 2>&1 | tee ../raw_full.log) & 
          
          # æå‰ç†”æ–­ç›‘æŽ§ï¼šä¸€æ—¦å‡ºçŽ° Fetching segments å°±æ€æŽ‰è¿›ç¨‹ï¼Œé˜²æ­¢è¿›å…¥æ•°åƒä¸ªåˆ†ç‰‡çš„æŠ“å–é˜¶æ®µ
          for i in {1..60}; do
            if grep -q "Fetching segments" ../raw_full.log; then
              echo "âœ… å·²æ•èŽ· 80+ ID å…¨é‡èœå•ï¼æ­£åœ¨æ‹¦æˆªä¸‹è½½ä»¥èŠ‚çœèµ„æº..."
              pkill -f python
              break
            fi
            sleep 1
          done
          
          # æ¸…æ´—æ—¥å¿—ï¼šç§»é™¤ ANSI é¢œè‰²ä»£ç ï¼Œä¿ç•™çº¯æ–‡æœ¬è¡¨æ ¼
          cd ..
          sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g" raw_full.log > Full_ID_Report.txt
          
          echo "=== æŽ¢æµ‹æŠ¥å‘Š (æˆªå–éƒ¨åˆ†) ==="
          grep -E "â”‚|â•­|â•°|ID|Codec|Bitrate|Language|Content|Range" Full_ID_Report.txt | tail -n 20

      - name: v5.6-Upload ID Report
        if: github.event.inputs.action_type == 'Probe_All_Details'
        uses: actions/upload-artifact@v4
        with:
          name: Full_ID_Report
          path: Full_ID_Report.txt

      # ---------------- æ¨¡å¼ 2ï¼šæ­£å¼ä¸‹è½½æ¨¡å¼ (é«˜ç²¾åº¦äº¤ä»˜) ----------------
      - name: v5.6-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ðŸš€ æ­£åœ¨æ ¹æ®è‡ªå®šä¹‰ ID åºåˆ—å¯åŠ¨ä¸‹è½½: "
          echo "${{ github.event.inputs.custom_sequence }}"
          # å®žé™…æ‰§è¡Œä¸‹è½½
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v5.6-Final Extraction
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          # å°è¯•ä»Ž output ç›®å½•ç§»åŠ¨
          if [ -d "./Manzana-Apple-TV-Plus-Trailers/output" ]; then
            mv ./Manzana-Apple-TV-Plus-Trailers/output/* ./final_delivery/
          fi
          # å…œåº•ï¼šæœç´¢æ ¹ç›®å½•ä¸‹æ‰€æœ‰ç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶
          find ./Manzana-Apple-TV-Plus-Trailers -maxdepth 2 -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./final_delivery/ \; 2>/dev/null || true

      - name: v5.6-Upload Video
        if: github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Final
          path: final_delivery/*
          retention-days: 7
