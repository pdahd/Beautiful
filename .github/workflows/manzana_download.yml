name: Apple Trailer Manzana (v4.2-Observer)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true
      action_type:
        type: choice
        description: 'ç¬¬ä¸€æ­¥ï¼šæ¢æµ‹æ‰€æœ‰ IDï¼›ç¬¬äºŒæ­¥ï¼šæ­£å¼ä¸‹è½½'
        options:
          - 'Probe_IDs_Only'
          - 'Formal_Download'
        default: 'Probe_IDs_Only'
      custom_sequence:
        description: 'ã€æ­£å¼ä¸‹è½½ã€‘å¡«å…¥åºåˆ— (å¦‚ 0\n13\nall\n4\nall\n2\n)'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v4.2-Checkout
        uses: actions/checkout@v4

      - name: v4.2-Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      # ---------------- æ¨¡å¼ 1ï¼šå•æ¬¡ç²¾å‡†æ¢æµ‹ ----------------
      - name: v4.2-Probe Mode
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ğŸ” æ­£åœ¨æŠ“å–æµä¿¡æ¯..."
          
          # ä½¿ç”¨ printf é¢„å¡«åºåˆ—ï¼Œå°†æ•´ä¸ªäº¤äº’è¿‡ç¨‹ä¿å­˜åˆ° raw_log.txt
          # åºåˆ—è®¾ä¸º 0\n0\n0\n0\n0\n0\n ä»¥å¿«é€Ÿèµ°å®Œæµç¨‹
          printf "0\n0\n0\n0\n0\n0\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d > ../raw_log.txt 2>&1 || true
          
          cd ..
          echo "=== æ­£åœ¨æ•´ç†æ¢æµ‹æŠ¥å‘Š ==="
          
          # æå–é€»è¾‘ï¼šä»ç¬¬ä¸€ä¸ªè¡¨æ ¼å¼€å§‹æˆªå–ï¼Œç›´åˆ°æ—¥å¿—ç»“æŸ
          # ç§»é™¤ ANSI é¢œè‰²ä»£ç ï¼Œä¿ç•™çº¯æ–‡æœ¬è¡¨æ ¼
          sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g" raw_log.txt > clean_log.txt
          
          # è¿‡æ»¤å‡ºæ‰€æœ‰åŒ…å«è¡¨æ ¼å­—ç¬¦å’Œå…³é”®ä¿¡æ¯çš„è¡Œ
          grep -E "â”‚|â•­|â•°|ID|Codec|Bitrate|Language|Content|INFO" clean_log.txt > Stream_Report.txt
          
          echo "--- æŠ¥å‘Šé¢„è§ˆ ---"
          cat Stream_Report.txt

      - name: v4.2-Upload Report
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        uses: actions/upload-artifact@v4
        with:
          name: Full_ID_Report_v4.2
          path: Stream_Report.txt

      # ---------------- æ¨¡å¼ 2ï¼šæ­£å¼ä¸‹è½½ ----------------
      - name: v4.2-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v4.2-Precision Extraction
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          # ç§»åŠ¨ Manzana è‡ªåŠ¨ç”Ÿæˆçš„ output ç›®å½•ä¸‹çš„æ–‡ä»¶
          [ -d "./Manzana-Apple-TV-Plus-Trailers/output" ] && mv ./Manzana-Apple-TV-Plus-Trailers/output/* ./final_delivery/ || true
          # ä¿åº•ç§»åŠ¨æ ¹ç›®å½•ä¸‹å¯èƒ½æ¼æ‰çš„æ–‡ä»¶
          find ./Manzana-Apple-TV-Plus-Trailers -maxdepth 1 -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./final_delivery/ \;

      - name: v4.2-Upload Result
        if: github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Final
          path: final_delivery/*
