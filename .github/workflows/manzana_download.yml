name: Apple Trailer Manzana Pro (Final)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: '粘贴 Apple TV+ 网页 URL'
        required: true
      mode:
        type: choice
        description: '选择下载预设'
        options:
          - '4K_HDR_Best'
          - '1080p_SDR_Best'
          - 'Custom_IDs'
        default: '4K_HDR_Best'
      custom_sequence:
        description: '如果选了 Custom_IDs，请填入序列'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Clone and Install
        run: |
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers
          pip install -r requirements.txt

      - name: Execute Manzana
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          
          # 定义输入序列
          if [ "${{ github.event.inputs.mode }}" == "4K_HDR_Best" ]; then
            INPUT_SEQ="0\n13\nall\nall\nall\nall\n"
          elif [ "${{ github.event.inputs.mode }}" == "1080p_SDR_Best" ]; then
            INPUT_SEQ="1\n11\nall\nall\nall\nall\n"
          else
            INPUT_SEQ="${{ github.event.inputs.custom_sequence }}"
          fi

          # 这里的 -d 参数让它自动选择 trailer
          printf "$INPUT_SEQ" | python manzana.py "${{ github.event.inputs.video_url }}" -d

      - name: Organize Files
        if: always()
        run: |
          # 创建一个统一的输出文件夹，把 Downloads 里的文件移出来
          mkdir -p output
          find Manzana-Apple-TV-Plus-Trailers/Downloads -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./output/ \;
          echo "已移动以下文件到 output 目录："
          ls -R ./output

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Package
          path: output/*
          retention-days: 1
