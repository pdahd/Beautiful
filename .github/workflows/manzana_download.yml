name: Apple Trailer Manzana (v4.1-DeepScan)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true
      action_type:
        type: choice
        description: 'ç¬¬ä¸€æ­¥ï¼šæ¢æµ‹æ‰€æœ‰ IDï¼›ç¬¬äºŒæ­¥ï¼šæ­£å¼ä¸‹è½½'
        options:
          - 'Probe_IDs_Only'
          - 'Formal_Download'
        default: 'Probe_IDs_Only'
      custom_sequence:
        description: 'ã€æ­£å¼ä¸‹è½½ã€‘å¡«å…¥åºåˆ— (å¦‚ 0\n13\nall\n4\nall\n2\n)'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v4.1-Checkout
        uses: actions/checkout@v4

      - name: v4.1-Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      # ---------------- æ¨¡å¼ 1ï¼šæ·±åº¦æ¢æµ‹ ----------------
      - name: v4.1-Deep Probe
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ğŸ” æ­£åœ¨è¿›è¡Œæ·±åº¦æ‰«æï¼Œè¯·ç¨å€™çº¦ 20 ç§’..."
          
          # ä½¿ç”¨ timeout ç¡®ä¿åœ¨å¼€å§‹ä¸‹è½½å‰é€€å‡º
          # é¢„å¡« 0 åºåˆ—è¯±å¯¼æ‰€æœ‰è¡¨æ ¼å¼¹å‡º
          timeout 40s python manzana.py "${{ github.event.inputs.video_url }}" -d <<EOF || true
          0
          0
          0
          0
          0
          0
          EOF
          
          # æ•è·æ‰€æœ‰å¸¦è¡¨æ ¼è¾¹æ¡†çš„è¡Œï¼Œè¿™äº›é€šå¸¸æ˜¯ ID åˆ—è¡¨
          # å°†ç»“æœé‡å®šå‘åˆ°æŠ¥å‘Š
          python manzana.py "${{ github.event.inputs.video_url }}" -d <<EOF | grep -E "â”‚|â•­|â•°|ID|Codec|Bitrate|Language" > ../Stream_Report.txt || true
          0
          0
          0
          0
          0
          0
          EOF

          echo "=== æ‰«æå®Œæˆï¼šä»¥ä¸‹ä¸ºæ•è·åˆ°çš„ ID æ¦‚è§ˆ ==="
          cat ../Stream_Report.txt

      - name: v4.1-Upload Report
        if: github.event.inputs.action_type == 'Probe_IDs_Only'
        uses: actions/upload-artifact@v4
        with:
          name: Full_ID_Report
          path: Stream_Report.txt

      # ---------------- æ¨¡å¼ 2ï¼šæ­£å¼ä¸‹è½½ (æ²¿ç”¨ v4.0) ----------------
      - name: v4.1-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v4.1-Precision Extraction
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          find ./Manzana-Apple-TV-Plus-Trailers/output -type f -exec mv {} ./final_delivery/ \; || find ./Manzana-Apple-TV-Plus-Trailers -name "*.mp4" -exec mv {} ./final_delivery/ \;

      - name: v4.1-Upload Result
        if: github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Final
          path: final_delivery/*
