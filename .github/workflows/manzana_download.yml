name: Apple Trailer Manzana (v5.9-Instant-Kill)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true
      action_type:
        type: choice
        description: 'æ¨¡å¼é€‰æ‹©'
        options:
          - 'Probe_All_Details'
          - 'Formal_Download'
        default: 'Probe_All_Details'
      custom_sequence:
        description: 'ã€æ­£å¼ä¸‹è½½å¡«å…¥ã€‘åºåˆ—ç¤ºä¾‹: 0\n13\nall\n4\nall\n2\n'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: v5.9-Checkout
        uses: actions/checkout@v4

      - name: v5.9-Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      # ---------------- æ¨¡å¼ 1ï¼šé›¶å»¶è¿Ÿçž¬æ€æŽ¢æµ‹ (æžå…¶åˆ©è½) ----------------
      - name: v5.9-Instant-Kill Probe
        if: github.event.inputs.action_type == 'Probe_All_Details'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ðŸ” å¯åŠ¨çž¬æ€æ‹¦æˆªæŽ¢æµ‹ (ç›®æ ‡: Fetching m3u8)..."
          
          # 1. å¯åŠ¨åŽå°æŽ¢æµ‹è¿›ç¨‹
          (printf "0\n13\nall\nall\nall\nall\n" | python manzana.py "${{ github.event.inputs.video_url }}" -d 2>&1 | tee ../raw_full.log) & 
          
          # 2. æ ¸å¿ƒæ‹¦æˆªå™¨ï¼šç›‘æŽ§æ—¥å¿—ï¼Œä¸€æ—¦å‘½ä¸­å…³é”®å­—ï¼Œç«‹å³å¼ºåˆ¶æ–©æ–­ Python è¿›ç¨‹
          # grep -m 1 åŒ¹é…åˆ°ç¬¬ä¸€æ¬¡åŽå°±ä¼šé€€å‡ºï¼Œè§¦å‘åŽé¢çš„ pkill -9
          tail -f ../raw_full.log | grep -m 1 "Fetching m3u8" && pkill -9 -f python 2>/dev/null || true
          
          echo "âœ… æ‹¦æˆªå·²è§¦å‘ï¼è¿›ç¨‹å·²åœ¨åˆ†ç‰‡æŠ“å–å‰è¢«æš´åŠ›ç»ˆæ­¢ã€‚"
          
          # 3. æ—¥å¿—æ¸…æ´—ä¸ŽæŠ¥å‘Šç”Ÿæˆ
          cd ..
          sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGK]//g" raw_full.log > Full_ID_Report.txt
          
          echo "=== æŽ¢æµ‹æŠ¥å‘Šæœ«å°¾é¢„è§ˆ ==="
          tail -n 20 Full_ID_Report.txt

      - name: v5.9-Upload ID Report
        if: github.event.inputs.action_type == 'Probe_All_Details'
        uses: actions/upload-artifact@v4
        with:
          name: Full_ID_Report
          path: Full_ID_Report.txt

      # ---------------- æ¨¡å¼ 2ï¼šæ­£å¼ä¸‹è½½ ----------------
      - name: v5.9-Execute Download
        if: github.event.inputs.action_type == 'Formal_Download'
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ðŸš€ å¯åŠ¨æ­£å¼ä¸‹è½½ï¼Œè‡ªå®šä¹‰åºåˆ—: "
          echo "${{ github.event.inputs.custom_sequence }}"
          # æ­£å¼æ‰§è¡Œï¼Œå¹¶è¿‡æ»¤æŽ‰ä¸‹è½½è¿‡ç¨‹ä¸­çš„ Fetching æ»šåŠ¨æ¡
          printf "${{ github.event.inputs.custom_sequence }}" | python manzana.py "${{ github.event.inputs.video_url }}" -d | grep -v "Fetching segments"

      - name: v5.9-Final Extraction
        if: always() && github.event.inputs.action_type == 'Formal_Download'
        run: |
          mkdir -p final_delivery
          if [ -d "./Manzana-Apple-TV-Plus-Trailers/output" ]; then
            mv ./Manzana-Apple-TV-Plus-Trailers/output/* ./final_delivery/
          fi
          find ./Manzana-Apple-TV-Plus-Trailers -maxdepth 2 -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./final_delivery/ \; 2>/dev/null || true

      - name: v5.9-Upload Video
        if: always() && github.event.inputs.action_type == 'Formal_Download'
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Result
          path: final_delivery/*
          retention-days: 7
