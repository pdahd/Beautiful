name: Apple Trailer Manzana (v5.7-Auto-Match)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ç²˜è´´ Apple TV+ ç½‘é¡µ URL'
        required: true

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers && pip install -r requirements.txt

      - name: v5.7-Smart-Sequence-Generator
        id: generator
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          # åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–è§£æè„šæœ¬
          cat << 'EOF' > auto_finder.py
          import sys, re
          # è¿™é‡Œæ¨¡æ‹Ÿæ¢æµ‹é€»è¾‘ï¼Œè™½ç„¶å¤æ‚ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Manzana çš„é»˜è®¤è¾“å‡º
          # æš‚æ—¶ä½¿ç”¨æˆ‘ä»¬æ‘¸ç´¢å‡ºçš„æœ€ç¨³å¥æ¨¡æ‹Ÿè¾“å…¥æ–¹å¼ï¼šå¢åŠ å»¶è¿Ÿ
          EOF
          
          # é’ˆå¯¹ GitHub ç¯å¢ƒï¼Œä½¿ç”¨æ–°çš„ç®¡é“æ§åˆ¶é€»è¾‘ï¼Œå¢åŠ æ¯æ­¥ 2 ç§’çš„å»¶è¿Ÿ
          echo "GEN_SEQ=2 && sleep 2 && echo 11 && sleep 2 && echo 3 && sleep 2 && echo 4 && sleep 2 && echo 0 && sleep 2 && echo 2" > ../cmd.sh

      - name: v5.7-Execute-Smart-Download
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          echo "ğŸš€ å¯åŠ¨å¸¦æœ‰å»¶è¿Ÿä¿æŠ¤çš„ä¸‹è½½ç¨‹åº..."
          # ä½¿ç”¨åˆ†æ­¥æ³¨å…¥æ³•ï¼Œè§£å†³è¾“å…¥è¿‡å¿«å¯¼è‡´çš„é”™ä½
          (echo 2; sleep 3; echo 11; sleep 3; echo 3; sleep 3; echo 4; sleep 3; echo 0; sleep 3; echo 2) | python manzana.py "${{ github.event.inputs.video_url }}" -d

      - name: v5.7-Extraction
        run: |
          mkdir -p final_delivery
          find ./Manzana-Apple-TV-Plus-Trailers -maxdepth 2 -type f \( -name "*.mp4" -o -name "*.mkv" \) -exec mv {} ./final_delivery/ \; 2>/dev/null || true

      - name: v5.6-Media-Inspect
        run: |
          echo "ğŸ“Š æ­£åœ¨æ·±åº¦æŸ¥è¯¢..."
          for file in ./final_delivery/*; do
            if [[ "$file" == *.mp4 ]]; then
              ffprobe -v error -show_entries "format=size:stream=codec_name,codec_type,width,height:stream_tags=language" -of default=noprint_wrappers=1 "$file"
            fi
          done

      - name: Upload Video
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_v5.7
          path: final_delivery/*
