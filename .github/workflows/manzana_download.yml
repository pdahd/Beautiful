name: Apple Trailer Manzana Pro

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: '粘贴 Apple TV+ 网页 URL'
        required: true
      mode:
        type: choice
        description: '选择下载预设'
        options:
          - '4K_HDR_Best'
          - '1080p_SDR_Best'
          - 'Custom_IDs'
        default: '4K_HDR_Best'
      custom_sequence:
        description: '如果选了 Custom_IDs，请填入序列（如 0\n13\nall\nall\nall\nall\n）'
        required: false
        default: ''

jobs:
  manzana-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gpac

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Clone and Install
        run: |
          git clone https://github.com/dropcreations/Manzana-Apple-TV-Plus-Trailers.git
          cd Manzana-Apple-TV-Plus-Trailers
          pip install -r requirements.txt

      - name: Execute Manzana
        run: |
          cd Manzana-Apple-TV-Plus-Trailers
          
          # 定义不同的输入序列 (6次输入: Range -> Stream -> AudioCodec -> AudioStream -> SubType -> SubStream)
          
          if [ "${{ github.event.inputs.mode }}" == "4K_HDR_Best" ]; then
            # 0:HDR -> 13:最高码率4K -> all:所有音频编码 -> all:所有音轨 -> all:所有字幕类型 -> all:所有字幕
            INPUT_SEQ="0\n13\nall\nall\nall\nall\n"
          elif [ "${{ github.event.inputs.mode }}" == "1080p_SDR_Best" ]; then
            # 1:SDR -> 11:最高码率1080p -> all -> all -> all -> all
            INPUT_SEQ="1\n11\nall\nall\nall\nall\n"
          else
            # 用户自定义模式
            INPUT_SEQ="${{ github.event.inputs.custom_sequence }}"
          fi

          echo "正在执行下载，使用序列: $INPUT_SEQ"
          printf "$INPUT_SEQ" | python manzana.py "${{ github.event.inputs.video_url }}" -d

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Apple_Video_Result
          path: |
             Manzana-Apple-TV-Plus-Trailers/*.mp4
             Manzana-Apple-TV-Plus-Trailers/*.mkv
          retention-days: 1
